<h1>Shopping cart</h1>

<% if @order.orderitems.any? %>
<table>
  <tr>
  <th>PHOTO</th>
  <th>NAME</th>
  <th>DESCRIPTION</th>
  <th>MERCHANT</th>
  <th>QUANTITY</th>
  <th>UNIT PRICE</th>
  <th>LINE PRICE</th>
  <th>REMOVE</th>
  </tr>
  <% sorted_items = @order.orderitems.order(:id) %>
  <% sorted_items.each do |item| %>
  <tr>
    <td><%= link_to image_tag(item.product.photo_url, alt:"#{item.product.name}"), product_path(item.product) %></td>
    <td><%= link_to "#{ item.product.name.capitalize }", product_path(item.product) %></td>
    <td><%= item.product.description %></td>
    <td><%= link_to "#{item.product.merchant.username}", merchant_path(item.product.merchant) %></td>
    <td><%= form_with model: item do |f| %>
      <%= f.hidden_field :id, value: @order.id %>
      <%= hidden_field_tag :old_quantity, item.quantity %>
      <%= f.label :quantity %>
      <% available = item.product.stock_qty + item.quantity %>
      <%= f.select :quantity, (1..available)%>
      <%= f.submit "Update quantity" %>
    <% end %></td>
    <td>$<%= sprintf('%.2f', item.product.price) %></td>
    <td>$<%= sprintf('%.2f', (item.quantity * item.product.price)) %></td>
    <td><%= button_to "Remove from cart", orderitem_path(item), method: :delete %></td>
  <% end %>  
  </tr>
  </table>
  <br>
  <br>
  <%= button_to "Checkout", checkout_path(@order), method: :get %><br><br>  
<% else %>
  Your shopping cart is empty.
<% end %>
